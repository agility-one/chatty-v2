<!DOCTYPE html>
<html lang="fr">

<!-- *** ChaTTY Bot v2 *** 

    GNU GENERAL PUBLIC LICENSE
    Version 3, 29 juin 2007

    Copyright (C) 2007 Free Software Foundation, Inc. <https://fsf.org/>
    Tout droit r√©serv√©.

    Vous pouvez redistribuer ce logiciel sous certaines conditions ; 
    voir la licence GNU General Public License pour plus de d√©tails.

    Ce logiciel est distribu√© dans l'espoir qu'il sera utile, 
    mais SANS AUCUNE GARANTIE ; sans m√™me la garantie implicite 
    de COMMERCIALISATION ou d'ADAPTATION √Ä UN USAGE PARTICULIER. 
    Voir la licence GNU General Public License pour plus de d√©tails.

    Vous devriez avoir re√ßu une copie de la licence GNU General Public License 
    avec ce logiciel. Si ce n'est pas le cas, consultez <https://www.gnu.org/licenses/>.

    Pour Browser js voir sa licence
-->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot - browser.js</title>
    <link id="themeStylesheet" rel="stylesheet" href="light-theme.css">

    <script src="./browser.js"></script>
    <script>
        async function loadJSON(filename) {
            const response = await fetch(filename);
            const jsonData = await response.json();
            return jsonData;
        }

        async function saveTrainingDataToFile(trainingData) {
            try {
                const response = await fetch('save_training_data.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(trainingData)
                });
                if (!response.ok) {
                    throw new Error('Erreur lors de la sauvegarde des donn√©es dans trainingData.json');
                }
            } catch (error) {
                console.error('Erreur de sauvegarde des donn√©es:', error);
            }
        }

        async function loadTrainingDataFromFile() {
            try {
                const response = await fetch('trainingData.json');
                const trainingData = await response.json();
                return trainingData;
            } catch (error) {
                console.error('Erreur lors du chargement des donn√©es d\'entra√Ænement:', error);
                return [];
            }
        }

        function loadTrainingData() {
            const storedData = localStorage.getItem('trainingData');
            return storedData ? JSON.parse(storedData) : [];
        }

        function saveTrainingData(trainingData) {
            localStorage.setItem('trainingData', JSON.stringify(trainingData));
            saveTrainingDataToFile(trainingData);
        }

        // Fonction de calcul de la distance de Levenshtein
        function levenshtein(a, b) {
            const matrix = [];

            if (a.length === 0) return b.length;
            if (b.length === 0) return a.length;

            for (let i = 0; i <= b.length; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= a.length; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1, // Substitution
                            Math.min(
                                matrix[i][j - 1] + 1, // Insertion
                                matrix[i - 1][j] + 1 // Suppression
                            )
                        );
                    }
                }
            }

            return matrix[b.length][a.length];
        }

        function findResponse(userInput, jsonData, trainingData) {
            userInput = userInput.toLowerCase().trim();

            // Recherche par mots simples d'abord
            let response = searchResponses(userInput, jsonData.responses);
            if (response) {
                return response;
            }

            // Recherche dans trainingData
            response = searchTrainingData(userInput, trainingData);
            if (response) {
                return response;
            }

            return null;
        }

// Fonction pour trouver une r√©ponse dans un jeu de donn√©es donn√© en utilisant des expressions r√©guli√®res et Levenshtein
function searchResponses(input, data) {
    let bestMatch = null;
    let minDistance = Infinity;
    const lowerInput = input.toLowerCase();



    // Continuation de la recherche avec le jeu de donn√©es
    for (const key in data) {
        const keywords = key.split(',').map(k => k.trim().toLowerCase());
        for (const keyword of keywords) {
            const regex = new RegExp(`\\b${keyword}\\b`, 'i');
            if (regex.test(lowerInput)) {
                const possibleResponses = Array.isArray(data[key]) ? data[key] : [data[key]];
                const randomIndex = Math.floor(Math.random() * possibleResponses.length);
                return possibleResponses[randomIndex]; // S√©lectionner une r√©ponse al√©atoire
            } else {
                const distance = levenshtein(lowerInput, keyword);
                if (distance < minDistance) {
                    minDistance = distance;
                    bestMatch = data[key];
                }
            }
        }
    }

    if (bestMatch !== null && minDistance < lowerInput.length * 0.4) { // Seuil de similitude
        const possibleResponses = Array.isArray(bestMatch) ? bestMatch : [bestMatch];
        const randomIndex = Math.floor(Math.random() * possibleResponses.length);
        return possibleResponses[randomIndex]; // S√©lectionner une r√©ponse al√©atoire
    }

    return null;
}

        // Recherche dans trainingData.json
        function searchTrainingData(input, trainingData) {
            let bestMatch = null;
            let minDistance = Infinity;

            for (const entry of trainingData) {
                const keywords = entry.input.split(',').map(k => k.trim().toLowerCase());
                for (const keyword of keywords) {
                    const regex = new RegExp(`\\b${keyword}\\b`, 'i');
                    if (regex.test(input)) {
                        const possibleResponses = Array.isArray(entry.output.response) ? entry.output.response : [entry.output.response];
                        const randomIndex = Math.floor(Math.random() * possibleResponses.length);
                        return possibleResponses[randomIndex]; // S√©lectionner une r√©ponse al√©atoire
                    } else {
                        const distance = levenshtein(input, keyword);
                        if (distance < minDistance) {
                            minDistance = distance;
                            bestMatch = entry.output.response;
                        }
                    }
                }
            }

            if (bestMatch !== null && minDistance < input.length * 0.4) { // Seuil de similitude
                const possibleResponses = Array.isArray(bestMatch) ? bestMatch : [bestMatch];
                const randomIndex = Math.floor(Math.random() * possibleResponses.length);
                return possibleResponses[randomIndex]; // S√©lectionner une r√©ponse al√©atoire
            }

            return null;
        }

// Tableau pour stocker l'historique des commandes
let commandHistory = [];
let historyIndex = -1;

function speakResponse(response) {
    const utterance = new SpeechSynthesisUtterance(response);
    speechSynthesis.speak(utterance);
}

function displayCurrentTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString();
    const completeSentence = "Il est " + timeString;
    const chatBubble = document.createElement('div');
    chatBubble.className = 'chat-bubble';
    chatBubble.innerText = "Chatbot: " + completeSentence;
    responseContainer.appendChild(chatBubble);
    responseContainer.scrollTop = responseContainer.scrollHeight; // Faire d√©filer vers le bas
    speakResponse(completeSentence); // Lire la r√©ponse √† haute voix
}

function displayCurrentDate() {
    const now = new Date();
    const dateString = now.toLocaleDateString();
    const completeSentence = "Nous sommes le " + dateString;
    const chatBubble = document.createElement('div');
    chatBubble.className = 'chat-bubble';
    chatBubble.innerText = "Chatbot: " + completeSentence;
    responseContainer.appendChild(chatBubble);
    responseContainer.scrollTop = responseContainer.scrollHeight; // Faire d√©filer vers le bas
    speakResponse(completeSentence); // Lire la r√©ponse √† haute voix
}

function clearMessages() {
    responseContainer.innerHTML = ''; // Effacer tous les messages
}

function stopSpeech() {
    speechSynthesis.cancel(); // Arr√™ter la voix du chatbot
}

        document.addEventListener('DOMContentLoaded', async () => {
            const jsonData = await loadJSON('responses.json');
            console.log('Donn√©es JSON charg√©es:', jsonData);

            let trainingData = loadTrainingData();
            console.log('Donn√©es d\'entra√Ænement charg√©es depuis localStorage:', trainingData);

            const fileTrainingData = await loadTrainingDataFromFile();
            console.log('Donn√©es d\'entra√Ænement charg√©es depuis trainingData.json:', fileTrainingData);

            // Fusion des donn√©es de localStorage et de trainingData.json
            trainingData = [...fileTrainingData, ...trainingData];
            console.log('Donn√©es d\'entra√Ænement fusionn√©es:', trainingData);

            const inputField = document.getElementById('userInput');
            const submitButton = document.getElementById('submitButton');
            const responseContainer = document.getElementById('responseContainer');
            const trainingContainer = document.getElementById('trainingContainer');

            // Configuration du r√©seau de neurones et de la variable net pour le r√©seau cach√© de neurones
            const net = new brain.NeuralNetwork({
                hiddenLayers: [3, 3], // Couches cach√©es : 3 couches de 3 neurones chacune
                learningRate: 0.6, // Taux d'apprentissage
                activation: 'sigmoid', // Fonction d'activation (peut √™tre 'sigmoid', 'relu', 'leaky-relu', 'tanh')
                errorThresh: 0.00001, // Seuil d'erreur
                log: true, // Activer les logs pour suivre l'entra√Ænement
                logPeriod: 100, // P√©riodicit√© des logs
                momentum: 0.5, // Taux de momentum pour l'entra√Ænement
                binaryThresh: 0.5 // Seuil pour les valeurs binaires
            });

            console.log('R√©seau de couches des neurones initialis√©');

            function trainNeuralNetwork(net, trainingData) {
                try {
                    if (trainingData.length > 0) {
                        console.log('Training Data (Avant formatage):', trainingData);

                        // Correction: V√©rification et normalisation des donn√©es
                        const formattedData = trainingData.map(item => ({
                            input: typeof item.input === 'string' ? item.input : JSON.stringify(item.input),
                            output: {
                                response: typeof item.output.response === 'string' ? item.output.response : JSON.stringify(item.output.response)
                            }
                        }));

                        console.log('Formatted Data (Apr√®s formatage):', formattedData);
                        net.train(formattedData, {
                            iterations: 10000,
                            log: true,
                            learningRate: 0.6,
                            errorThresh: 0.00001,
                            callback: function (status) { // Fonction de rappel pour chaque p√©riode de log
                                console.log(`It√©rations : ${status.iterations}, Erreur d'entra√Ænement : ${status.error}`); // Ajout du log ici
                            },
                            callbackPeriod: 100 // P√©riodicit√© de la fonction de rappel
                        });
                        console.log('R√©entra√Ænement termin√©');
                    } else {
                        console.log('Aucune donn√©e d\'entra√Ænement disponible');
                    }
                } catch (error) {
                    console.error('Erreur lors de l\'entra√Ænement du r√©seau de neurones:', error);
                }
            }

            if (trainingData.length > 0) {
                console.log('Entra√Ænement initial du r√©seau de neurones...');
                trainNeuralNetwork(net, trainingData);
            }

// Fonction pour g√©rer l'envoi avec la touche Enter
inputField.addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
        submitButton.click();
    }
});

submitButton.addEventListener('click', () => {
    const userInput = inputField.value.trim().toLowerCase();
    
    // Enregistrer l'historique des commandes
    commandHistory.push(userInput);
    historyIndex = commandHistory.length;
    
    // V√©rifier les mots-cl√©s sp√©ciaux
    const specialKeywords = {
        "heure": displayCurrentTime,
        "date": displayCurrentDate,
        "clear": clearMessages,
        "stop": stopSpeech,
        "google": () => window.open("https://www.google.com", "_blank"),
        "bing": () => window.open("https://www.bing.com", "_blank"),
        "wikipedia": () => window.open("https://fr.wikipedia.org/wiki/Wikip√©dia", "_blank"),
        "projets raspberry": () => window.open("https://projects.raspberrypi.org/fr-FR", "_blank"),
        "kubii": () => window.open("https://www.kubii.com/fr/", "_blank"),
        "meteo": () => window.open("https://wttr.in/digoin", "_blank"),
        "metar": () => window.open("https://www.meteoblue.com/fr/meteo/cartes/widget/paris-12_france_6618618", "_blank")
    };

    for (const keyword in specialKeywords) {
        if (userInput.includes(keyword)) {
            specialKeywords[keyword]();
            //const chatBubble = document.createElement('div');
            //chatBubble.className = 'chat-bubble';
            //chatBubble.innerText = "Chatbot: [Action ex√©cut√©e]"; 
            //responseContainer.appendChild(chatBubble);
            responseContainer.scrollTop = responseContainer.scrollHeight; // Faire d√©filer vers le bas
            inputField.value = ''; // Effacer le contenu de l'input apr√®s ex√©cution de la commande
            return;
        }
    }
    
    let response = findResponse(userInput, jsonData, trainingData);
    if (!response) {
        response = null; // Aucune r√©ponse trouv√©e dans les donn√©es d'entra√Ænement ou JSON
        trainingContainer.style.display = 'flex';
        document.getElementById('trainingQuestion').value = userInput;
        inputField.value = ''; // Effacer le contenu de l'input apr√®s soumission
        return;
    }
    const chatBubble = document.createElement('div');
    chatBubble.className = 'chat-bubble';
    chatBubble.innerText = "Chatbot: " + response;
    responseContainer.appendChild(chatBubble);
    responseContainer.scrollTop = responseContainer.scrollHeight; // Faire d√©filer vers le bas

    speakResponse(response); // Lire la r√©ponse √† haute voix
    inputField.value = ''; // Effacer le contenu de l'input apr√®s soumission
});


            const addTrainingDataButton = document.getElementById('addTrainingDataButton');
            const cancelTrainingDataButton = document.getElementById('cancelTrainingDataButton');

            // Fusion des donn√©es de localStorage et de trainingData.json sans doublons
            trainingData = [...fileTrainingData, ...trainingData].filter((item, index, self) =>
                index === self.findIndex((t) => (
                    t.input === item.input && t.output.response === item.output.response
                ))
            );
            console.log('Donn√©es d\'entra√Ænement fusionn√©es:', trainingData);


            addTrainingDataButton.addEventListener('click', () => {
                const question = document.getElementById('trainingQuestion').value;
                const response = document.getElementById('trainingResponse').value;

                // V√©rification des doublons avant d'ajouter
                const exists = trainingData.some(item => item.input === question && item.output.response === response);
                if (!exists) {
                    trainingData.push({ input: question, output: { response: response } });
                    console.log('Nouvelle donn√©e ajout√©e:', { input: question, output: { response: response } });
                } else {
                    console.log('La donn√©e existe d√©j√† :', { input: question, output: { response: response } });
                }

                // Sauvegarde des donn√©es apr√®s filtrage des doublons
                const uniqueTrainingData = trainingData.filter((item, index, self) =>
                    index === self.findIndex((t) => (
                        t.input === item.input && t.output.response === item.output.response
                    ))
                );

                saveTrainingData(uniqueTrainingData);

                // Correction: V√©rification et normalisation des donn√©es
                const formattedData = uniqueTrainingData.map(item => ({
                    input: typeof item.input === 'string' ? item.input : JSON.stringify(item.input),
                    output: {
                        response: typeof item.output.response === 'string' ? item.output.response : JSON.stringify(item.output.response)
                    }
                }));

                trainNeuralNetwork(net, uniqueTrainingData);
                console.log('R√©entra√Ænement termin√©');
                trainingContainer.style.display = 'none';
                document.getElementById('trainingQuestion').value = '';
                document.getElementById('trainingResponse').value = '';
            });

            cancelTrainingDataButton.addEventListener('click', () => {
                trainingContainer.style.display = 'none';
                document.getElementById('trainingQuestion').value = '';
                document.getElementById('trainingResponse').value = '';
            });

            function speakResponse(response) {
                const utterance = new SpeechSynthesisUtterance(response);
                speechSynthesis.speak(utterance);
            }
        });
    </script>
</head>

<body>
    <div id="chat-container">
        <div id="header">Chatty Bot <button id="themeToggle" onclick="toggleTheme()">üåû/üåú</button></div>
        <div id="responseContainer"></div>
        <div id="inputContainer">
            <input type="text" id="userInput" placeholder="Entrez votre question...">
            <button id="submitButton">Envoyer</button>
        </div>
        <div id="trainingContainer">
            <input type="text" id="trainingQuestion" placeholder="Nouvelle Question...">
            <input type="text" id="trainingResponse" placeholder="Nouvelle R√©ponse...">
            <button id="addTrainingDataButton">Ajouter</button>
            <button id="cancelTrainingDataButton">Annuler</button>
        </div>
    </div>

    <script>
        function toggleTheme() {
            const themeStylesheet = document.getElementById('themeStylesheet');
            const currentTheme = themeStylesheet.getAttribute('href');
            
            if (currentTheme === 'light-theme.css') {
                themeStylesheet.setAttribute('href', 'dark-theme.css');
            } else {
                themeStylesheet.setAttribute('href', 'light-theme.css');
            }
        }
    </script>
</body>

</html>